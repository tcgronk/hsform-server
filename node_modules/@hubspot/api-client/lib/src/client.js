"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
    result["default"] = mod;
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const bottleneck_1 = __importDefault(require("bottleneck"));
const crypto = require("crypto");
const _ = __importStar(require("lodash"));
const qs = __importStar(require("querystring"));
const request = require("request");
// @ts-ignore
const pJson = __importStar(require("../../package.json"));
const api_1 = require("../codegen/cms/audit_logs/api");
const auditLogsModels = __importStar(require("../codegen/cms/audit_logs/model/models"));
exports.auditLogsModels = auditLogsModels;
const api_2 = require("../codegen/cms/domains/api");
const domainsModels = __importStar(require("../codegen/cms/domains/model/models"));
exports.domainsModels = domainsModels;
const api_3 = require("../codegen/cms/performance/api");
const performanceModels = __importStar(require("../codegen/cms/performance/model/models"));
exports.performanceModels = performanceModels;
const api_4 = require("../codegen/cms/site_search/api");
const siteSearchModels = __importStar(require("../codegen/cms/site_search/model/models"));
exports.siteSearchModels = siteSearchModels;
const api_5 = require("../codegen/cms/url_redirects/api");
const urlRedirectsModels = __importStar(require("../codegen/cms/url_redirects/model/models"));
exports.urlRedirectsModels = urlRedirectsModels;
const api_6 = require("../codegen/crm/associations/api");
const associationsModels = __importStar(require("../codegen/crm/associations/model/models"));
exports.associationsModels = associationsModels;
const api_7 = require("../codegen/crm/companies/api");
const companiesModels = __importStar(require("../codegen/crm/companies/model/models"));
exports.companiesModels = companiesModels;
const api_8 = require("../codegen/crm/contacts/api");
const contactsModels = __importStar(require("../codegen/crm/contacts/model/models"));
exports.contactsModels = contactsModels;
const api_9 = require("../codegen/crm/deals/api");
const dealsModels = __importStar(require("../codegen/crm/deals/model/models"));
exports.dealsModels = dealsModels;
const api_10 = require("../codegen/crm/extensions/cards/api");
const cardsModels = __importStar(require("../codegen/crm/extensions/cards/model/models"));
exports.cardsModels = cardsModels;
const coreApi_1 = require("../codegen/crm/imports/api/coreApi");
const importsModels = __importStar(require("../codegen/crm/imports/model/models"));
exports.importsModels = importsModels;
const api_11 = require("../codegen/crm/line_items/api");
const lineItemsModels = __importStar(require("../codegen/crm/line_items/model/models"));
exports.lineItemsModels = lineItemsModels;
const api_12 = require("../codegen/crm/owners/api");
const ownersModels = __importStar(require("../codegen/crm/owners/model/models"));
exports.ownersModels = ownersModels;
const api_13 = require("../codegen/crm/pipelines/api");
const pipelinesModels = __importStar(require("../codegen/crm/pipelines/model/models"));
exports.pipelinesModels = pipelinesModels;
const api_14 = require("../codegen/crm/products/api");
const productsModels = __importStar(require("../codegen/crm/products/model/models"));
exports.productsModels = productsModels;
const api_15 = require("../codegen/crm/properties/api");
const propertiesModels = __importStar(require("../codegen/crm/properties/model/models"));
exports.propertiesModels = propertiesModels;
const api_16 = require("../codegen/crm/quotes/api");
const quotesModels = __importStar(require("../codegen/crm/quotes/model/models"));
exports.quotesModels = quotesModels;
const api_17 = require("../codegen/crm/tickets/api");
const ticketsModels = __importStar(require("../codegen/crm/tickets/model/models"));
exports.ticketsModels = ticketsModels;
const api_18 = require("../codegen/crm/timeline/api");
const timelineModels = __importStar(require("../codegen/crm/timeline/model/models"));
exports.timelineModels = timelineModels;
const api_19 = require("../codegen/oauth/api");
const oauthModels = __importStar(require("../codegen/oauth/model/models"));
exports.oauthModels = oauthModels;
const api_20 = require("../codegen/webhooks/api");
const webhooksModels = __importStar(require("../codegen/webhooks/model/models"));
exports.webhooksModels = webhooksModels;
const DEFAULT_HEADERS = { 'User-Agent': `hubspot-api-client-nodejs; ${pJson.version}` };
const DEFAULT_LIMITER_OPTIONS = {
    minTime: 1000 / 9,
    maxConcurrent: 6,
    id: 'hubspot-client-limiter',
};
const SEARCH_LIMITER_MIN_TIME = 550;
const SEARCH_METHOD_NAME = 'doSearch';
const METHOD_NAMES_TO_EXCLUDE_FROM_PATCHING = [
    'constructor',
    'useQuerystring',
    'basePath',
    'defaultHeaders',
    'setDefaultAuthentication',
    'setApiKey',
    'accessToken',
    'addInterceptor',
];
const RETRY_TIMEOUT = {
    INTERNAL_SERVER_ERROR: 200,
    TOO_MANY_REQUESTS: 10 * 1000,
    TOO_MANY_SEARCH_REQUESTS: 1000,
};
const TEN_SECONDLY_ROLLING = 'TEN_SECONDLY_ROLLING';
const SECONDLY_LIMIT_MESSAGE = 'You have reached your secondly limit.';
var NumberOfRetries;
(function (NumberOfRetries) {
    NumberOfRetries[NumberOfRetries["NoRetries"] = 0] = "NoRetries";
    NumberOfRetries[NumberOfRetries["One"] = 1] = "One";
    NumberOfRetries[NumberOfRetries["Two"] = 2] = "Two";
    NumberOfRetries[NumberOfRetries["Three"] = 3] = "Three";
    NumberOfRetries[NumberOfRetries["Four"] = 4] = "Four";
    NumberOfRetries[NumberOfRetries["Five"] = 5] = "Five";
    NumberOfRetries[NumberOfRetries["Six"] = 6] = "Six";
})(NumberOfRetries = exports.NumberOfRetries || (exports.NumberOfRetries = {}));
class HttpError extends Error {
    constructor(response, body, statusCode) {
        super('HTTP request failed');
        this.response = response;
        this.body = body;
        this.statusCode = statusCode;
        this.name = 'HttpError';
    }
}
exports.HttpError = HttpError;
class Client {
    constructor(options = {}) {
        this._interceptors = [];
        this._basePath = 'https://api.hubapi.com';
        this.authentications = {
            hapikey: new api_12.ApiKeyAuth('query', 'hapikey'),
            oauth2: new api_12.OAuth(),
        };
        this._useLimiter = true;
        this._useSearchLimiter = false;
        this._oauthDefaultApi = new api_19.DefaultApi();
        this._associationsBatchApi = new api_6.BatchApi();
        this._typesApi = new api_6.TypesApi();
        this._companiesAssociationsApi = new api_7.AssociationsApi();
        this._companiesBasicApi = new api_7.BasicApi();
        this._companiesBatchApi = new api_7.BatchApi();
        this._companiesSearchApi = new api_7.SearchApi();
        this._contactsAssociationsApi = new api_8.AssociationsApi();
        this._contactsBasicApi = new api_8.BasicApi();
        this._contactsBatchApi = new api_8.BatchApi();
        this._contactsSearchApi = new api_8.SearchApi();
        this._dealsAssociationsApi = new api_9.AssociationsApi();
        this._dealsBasicApi = new api_9.BasicApi();
        this._dealsBatchApi = new api_9.BatchApi();
        this._dealsSearchApi = new api_9.SearchApi();
        this._cardsApi = new api_10.CardsApi();
        this._cardsSampleResponseApi = new api_10.SampleResponseApi();
        this._importsCoreApi = new coreApi_1.CoreApi();
        this._lineItemsAssociationsApi = new api_11.AssociationsApi();
        this._lineItemsBasicApi = new api_11.BasicApi();
        this._lineItemsBatchApi = new api_11.BatchApi();
        this._lineItemsSearchApi = new api_11.SearchApi();
        this._ownersDefaultApi = new api_12.DefaultApi();
        this._pipelinesApi = new api_13.PipelinesApi();
        this._pipelineStagesApi = new api_13.PipelineStagesApi();
        this._productsAssociationsApi = new api_14.AssociationsApi();
        this._productsBasicApi = new api_14.BasicApi();
        this._productsBatchApi = new api_14.BatchApi();
        this._productsSearchApi = new api_14.SearchApi();
        this._propertiesBatchApi = new api_15.BatchApi();
        this._propertiesCoreApi = new api_15.CoreApi();
        this._propertiesGroupsApi = new api_15.GroupsApi();
        this._quotesAssociationsApi = new api_16.AssociationsApi();
        this._quotesBasicApi = new api_16.BasicApi();
        this._quotesBatchApi = new api_16.BatchApi();
        this._quotesSearchApi = new api_16.SearchApi();
        this._ticketsAssociationsApi = new api_17.AssociationsApi();
        this._ticketsBasicApi = new api_17.BasicApi();
        this._ticketsBatchApi = new api_17.BatchApi();
        this._ticketsSearchApi = new api_17.SearchApi();
        this._eventsApi = new api_18.EventsApi();
        this._templatesApi = new api_18.TemplatesApi();
        this._tokensApi = new api_18.TokensApi();
        this._settingsApi = new api_20.SettingsApi();
        this._subscriptionsApi = new api_20.SubscriptionsApi();
        this._auditLogsDefaultApi = new api_1.DefaultApi();
        this._domainsApi = new api_2.DomainsApi();
        this._performanceDefaultApi = new api_3.DefaultApi();
        this._redirectsApi = new api_5.RedirectsApi();
        this._siteSearchDefaultApi = new api_4.DefaultApi();
        this._apiClientsWithApiKeyAuth = [
            this._associationsBatchApi,
            this._typesApi,
            this._companiesAssociationsApi,
            this._companiesBasicApi,
            this._companiesBatchApi,
            this._companiesSearchApi,
            this._contactsAssociationsApi,
            this._contactsBasicApi,
            this._contactsBatchApi,
            this._contactsSearchApi,
            this._dealsAssociationsApi,
            this._dealsBasicApi,
            this._dealsBatchApi,
            this._dealsSearchApi,
            this._importsCoreApi,
            this._lineItemsAssociationsApi,
            this._lineItemsBasicApi,
            this._lineItemsBatchApi,
            this._lineItemsSearchApi,
            this._ownersDefaultApi,
            this._pipelinesApi,
            this._pipelineStagesApi,
            this._productsAssociationsApi,
            this._productsBasicApi,
            this._productsBatchApi,
            this._productsSearchApi,
            this._propertiesBatchApi,
            this._propertiesCoreApi,
            this._propertiesGroupsApi,
            this._quotesAssociationsApi,
            this._quotesBasicApi,
            this._quotesBatchApi,
            this._quotesSearchApi,
            this._ticketsAssociationsApi,
            this._ticketsBasicApi,
            this._ticketsBatchApi,
            this._ticketsSearchApi,
            this._templatesApi,
            this._tokensApi,
            this._domainsApi,
            this._redirectsApi,
            this._siteSearchDefaultApi,
        ];
        this._apiClientsWithDevApiKeyAuth = [
            this._auditLogsDefaultApi,
            this._cardsApi,
            this._settingsApi,
            this._subscriptionsApi,
            this._performanceDefaultApi,
        ];
        this._apiClients = [
            ...this._apiClientsWithApiKeyAuth,
            ...this._apiClientsWithDevApiKeyAuth,
            this._oauthDefaultApi,
            this._cardsSampleResponseApi,
            this._eventsApi,
        ];
        this._numberOfApiCallRetries = NumberOfRetries.NoRetries;
        this._setUseQuerystring(true);
        this._setOptions(options);
        this.crm = {
            associations: {
                batchApi: this._associationsBatchApi,
                typesApi: this._typesApi,
            },
            companies: {
                associationsApi: this._companiesAssociationsApi,
                basicApi: this._companiesBasicApi,
                batchApi: this._companiesBatchApi,
                searchApi: this._companiesSearchApi,
                getAll: this._retrieveGetAllFunction(this._companiesBasicApi.getPage.bind(this._companiesBasicApi)),
            },
            contacts: {
                associationsApi: this._contactsAssociationsApi,
                basicApi: this._contactsBasicApi,
                batchApi: this._contactsBatchApi,
                searchApi: this._contactsSearchApi,
                getAll: this._retrieveGetAllFunction(this._contactsBasicApi.getPage.bind(this._contactsBasicApi)),
            },
            deals: {
                associationsApi: this._dealsAssociationsApi,
                basicApi: this._dealsBasicApi,
                batchApi: this._dealsBatchApi,
                searchApi: this._dealsSearchApi,
                getAll: this._retrieveGetAllFunction(this._dealsBasicApi.getPage.bind(this._dealsBasicApi)),
            },
            extensions: {
                cards: {
                    cardsApi: this._cardsApi,
                    sampleResponseApi: this._cardsSampleResponseApi,
                },
            },
            imports: {
                coreApi: this._importsCoreApi,
            },
            lineItems: {
                associationsApi: this._lineItemsAssociationsApi,
                basicApi: this._lineItemsBasicApi,
                batchApi: this._lineItemsBatchApi,
                searchApi: this._lineItemsSearchApi,
                getAll: this._retrieveGetAllFunction(this._lineItemsBasicApi.getPage.bind(this._lineItemsBasicApi)),
            },
            owners: {
                defaultApi: this._ownersDefaultApi,
            },
            pipelines: {
                pipelinesApi: this._pipelinesApi,
                pipelineStagesApi: this._pipelineStagesApi,
            },
            products: {
                associationsApi: this._productsAssociationsApi,
                basicApi: this._productsBasicApi,
                batchApi: this._productsBatchApi,
                searchApi: this._productsSearchApi,
                getAll: this._retrieveGetAllFunction(this._productsBasicApi.getPage.bind(this._productsBasicApi)),
            },
            properties: {
                batchApi: this._propertiesBatchApi,
                coreApi: this._propertiesCoreApi,
                groupsApi: this._propertiesGroupsApi,
            },
            quotes: {
                associationsApi: this._quotesAssociationsApi,
                basicApi: this._quotesBasicApi,
                batchApi: this._quotesBatchApi,
                searchApi: this._quotesSearchApi,
                getAll: this._retrieveGetAllFunction(this._quotesBasicApi.getPage.bind(this._quotesBasicApi)),
            },
            tickets: {
                associationsApi: this._ticketsAssociationsApi,
                basicApi: this._ticketsBasicApi,
                batchApi: this._ticketsBatchApi,
                searchApi: this._ticketsSearchApi,
                getAll: this._retrieveGetAllFunction(this._ticketsBasicApi.getPage.bind(this._ticketsBasicApi)),
            },
            timeline: {
                eventsApi: this._eventsApi,
                templatesApi: this._templatesApi,
                tokensApi: this._tokensApi,
            },
        };
        this.oauth = {
            defaultApi: this._oauthDefaultApi,
            getAuthorizationUrl: this._getAuthorizationUrl,
        };
        this.webhooks = {
            settingsApi: this._settingsApi,
            subscriptionsApi: this._subscriptionsApi,
            validateSignature: this._validateSignature,
        };
        this.cms = {
            auditLogs: {
                defaultApi: this._auditLogsDefaultApi,
            },
            domains: {
                domainsApi: this._domainsApi,
            },
            performance: {
                defaultApi: this._performanceDefaultApi,
            },
            urlRedirects: {
                redirectsApi: this._redirectsApi,
            },
            sireSearch: {
                defaultApi: this._siteSearchDefaultApi,
            },
        };
    }
    setApiKey(apiKeyToSet) {
        this._apiKey = apiKeyToSet;
        this.authentications.hapikey.apiKey = apiKeyToSet;
        _.each(this._apiClientsWithApiKeyAuth, (apiClient) => {
            apiClient.setApiKey(0, apiKeyToSet);
        });
    }
    setDeveloperApiKey(developerApiKeyToSet) {
        this._developerApiKey = developerApiKeyToSet;
        _.each(this._apiClientsWithDevApiKeyAuth, (apiClient) => {
            apiClient.setApiKey(0, developerApiKeyToSet);
        });
    }
    setBasePath(basePathToSet) {
        if (_.isNil(basePathToSet)) {
            return;
        }
        this._basePath = basePathToSet.replace(/\/+$/, '');
        _.each(this._apiClients, (apiClient) => {
            apiClient.basePath = this._basePath;
        });
    }
    setAccessToken(accessTokenToSet) {
        this._accessToken = accessTokenToSet;
        this.authentications.oauth2.accessToken = accessTokenToSet;
        _.each(this._apiClients, (apiClient) => {
            apiClient.accessToken = accessTokenToSet;
        });
    }
    addInterceptor(interceptor) {
        this._interceptors.push(interceptor);
        _.each(this._apiClients, (apiClient) => {
            apiClient.addInterceptor(interceptor);
        });
    }
    setDefaultHeaders(defaultHeadersToSet) {
        this._defaultHeaders = _.assign({}, defaultHeadersToSet, DEFAULT_HEADERS);
        _.each(this._apiClients, (apiClient) => {
            apiClient.defaultHeaders = this._defaultHeaders;
        });
    }
    setAuth(options = {}) {
        if (options.apiKey) {
            this.setApiKey(options.apiKey);
        }
        if (options.developerApiKey) {
            this.setDeveloperApiKey(options.developerApiKey);
        }
        if (options.accessToken) {
            this.setAccessToken(options.accessToken);
        }
    }
    getOptions() {
        return {
            basePath: this._basePath,
            defaultHeaders: this._defaultHeaders,
            apiKey: this._apiKey,
            developerApiKey: this._developerApiKey,
            accessToken: this._accessToken,
            useLimiter: this._useLimiter,
            limiterOptions: this._limiterOptions,
            numberOfApiCallRetries: this._numberOfApiCallRetries,
            interceptors: this._interceptors,
        };
    }
    apiRequest(opts) {
        const params = _.cloneDeep(opts);
        params.method = params.method || 'GET';
        params.json = true;
        params.resolveWithFullResponse = true;
        params.url = params.overlapUrl || this._basePath + (params.path || '');
        delete params.overlapUrl;
        delete params.path;
        params.qsStringifyOptions = {
            arrayFormat: 'repeat',
        };
        params.qs = Object.assign({}, params.qs);
        params.headers = _.assign({}, opts.headers, this._defaultHeaders);
        if (this.authentications.hapikey.apiKey) {
            this.authentications.hapikey.applyToRequest(params);
        }
        if (this.authentications.oauth2.accessToken) {
            this.authentications.oauth2.applyToRequest(params);
        }
        let authenticationPromise = Promise.resolve();
        if (this.authentications.hapikey.apiKey) {
            authenticationPromise = authenticationPromise.then(() => this.authentications.hapikey.applyToRequest(params));
        }
        if (this.authentications.oauth2.accessToken) {
            authenticationPromise = authenticationPromise.then(() => this.authentications.oauth2.applyToRequest(params));
        }
        let interceptorPromise = authenticationPromise;
        for (const interceptor of this._interceptors) {
            interceptorPromise = interceptorPromise.then(() => interceptor(params));
        }
        return interceptorPromise.then(() => {
            return new Promise((resolve, reject) => {
                request(params, (error, response, body) => {
                    if (error) {
                        reject(error);
                    }
                    else {
                        if (response.statusCode && response.statusCode >= 200 && response.statusCode <= 299) {
                            resolve({ response, body });
                        }
                        else {
                            reject(new HttpError(response, body, response.statusCode));
                        }
                    }
                });
            });
        });
    }
    _getAuthorizationUrl(clientId, redirectUri, scope, optionalScope, state) {
        const params = {
            client_id: clientId,
            redirect_uri: redirectUri,
            scope,
            optional_scope: optionalScope,
            state,
        };
        return `https://app.hubspot.com/oauth/authorize?${qs.stringify(_.omitBy(params, _.isNil))}`;
    }
    _validateSignature(signature, clientSecret, requestBody, signatureVersion = 'v1', webhooksUrl, webhooksMethod = 'POST') {
        const sourceString = _.isEqual(signatureVersion, 'v1')
            ? clientSecret + requestBody
            : clientSecret + webhooksMethod + webhooksUrl + requestBody;
        const hash = crypto
            .createHash('sha256')
            .update(sourceString)
            .digest('hex');
        return _.isEqual(signature, hash);
    }
    _retrieveGetAllFunction(getPageFunction) {
        return (limit, after, properties, associations, archived, options) => __awaiter(this, void 0, void 0, function* () {
            const limitInternal = limit !== null && limit !== void 0 ? limit : 100;
            let afterInternal = after;
            const result = [];
            let response;
            do {
                response = yield getPageFunction(limitInternal, afterInternal, properties, associations, archived, options);
                afterInternal = _.get(response, 'body.paging.next.after');
                result.push(..._.get(response, 'body.results'));
            } while (!_.isNil(afterInternal));
            return result;
        });
    }
    _setOptions(options) {
        this.setAuth(options);
        this.setBasePath(options.basePath);
        this.setDefaultHeaders(options.defaultHeaders);
        this._setMethodsPatchOptions(options);
        this._setInterceptors(options);
    }
    _setUseQuerystring(useQuerystring) {
        _.each(this._apiClients, (apiClient) => (apiClient._useQuerystring = useQuerystring));
    }
    _getLimiterWrappedMethod(method) {
        if (!this._limiter) {
            throw new Error('Limiter not defined');
        }
        return this._limiter.wrap(method);
    }
    _getSearchLimiterWrappedMethod(method) {
        if (!this._searchLimiter) {
            throw new Error('Search Limiter not defined');
        }
        return this._searchLimiter.wrap(method);
    }
    _waitAfterRequestFailure(statusCode, retryNumber, retryTimeout) {
        console.error(`Request failed with status code [${statusCode}], will retry [${retryNumber}] time in [${retryTimeout}] ms`);
        return new Promise((resolve) => setTimeout(resolve, retryTimeout * retryNumber));
    }
    _getRetryWrappedMethod(method) {
        return (...args) => __awaiter(this, void 0, void 0, function* () {
            const numberOfRetries = this._numberOfApiCallRetries.valueOf() + 1;
            let resultSuccess;
            let resultRejected;
            for (let index = 1; index <= numberOfRetries; index++) {
                try {
                    resultSuccess = yield method(...args);
                    resultRejected = null;
                    break;
                }
                catch (e) {
                    resultRejected = e;
                    if (_.isEqual(index, numberOfRetries)) {
                        break;
                    }
                    const statusCode = _.get(e, 'response.statusCode');
                    if (statusCode >= 500 && statusCode <= 599) {
                        yield this._waitAfterRequestFailure(statusCode, index, RETRY_TIMEOUT.INTERNAL_SERVER_ERROR);
                        continue;
                    }
                    if (_.isEqual(statusCode, 429)) {
                        const policyName = _.get(e, 'response.body.policyName');
                        if (_.isEqual(policyName, TEN_SECONDLY_ROLLING)) {
                            yield this._waitAfterRequestFailure(statusCode, index, RETRY_TIMEOUT.TOO_MANY_REQUESTS);
                            continue;
                        }
                        const message = _.get(e, 'response.body.message');
                        if (_.isEqual(message, SECONDLY_LIMIT_MESSAGE)) {
                            yield this._waitAfterRequestFailure(statusCode, index, RETRY_TIMEOUT.TOO_MANY_SEARCH_REQUESTS);
                            continue;
                        }
                    }
                    break;
                }
            }
            return new Promise((resolve, reject) => {
                if (resultRejected) {
                    return reject(resultRejected);
                }
                return resolve(resultSuccess);
            });
        });
    }
    _patchApiClientMethod(methodName, clientInstance, clientPrototype) {
        const methodToPatch = clientPrototype[methodName].bind(clientInstance);
        let patchedMethod = methodToPatch;
        if (this._useSearchLimiter && _.isEqual(methodName, SEARCH_METHOD_NAME)) {
            patchedMethod = this._getSearchLimiterWrappedMethod(methodToPatch);
        }
        if (this._useLimiter) {
            patchedMethod = this._getLimiterWrappedMethod(patchedMethod);
        }
        if (!_.isEqual(this._numberOfApiCallRetries, NumberOfRetries.NoRetries)) {
            patchedMethod = this._getRetryWrappedMethod(patchedMethod);
        }
        clientInstance[methodName] = patchedMethod;
    }
    _patchApiClient(clientInstance) {
        const clientPrototype = Object.getPrototypeOf(clientInstance);
        let methodsNamesToPatch = Object.getOwnPropertyNames(clientPrototype);
        methodsNamesToPatch = _.differenceWith(methodsNamesToPatch, METHOD_NAMES_TO_EXCLUDE_FROM_PATCHING);
        const patchFn = this._patchApiClientMethod.bind(this);
        _.each(methodsNamesToPatch, (methodName) => {
            patchFn(methodName, clientInstance, clientPrototype);
        });
    }
    _patchApiClients() {
        _.each(this._apiClients, this._patchApiClient.bind(this));
    }
    _patchApiRequestMethod() {
        let apiRequestMethodToPatch = this.apiRequest.bind(this);
        if (this._useLimiter) {
            apiRequestMethodToPatch = this._getLimiterWrappedMethod(apiRequestMethodToPatch);
        }
        if (!_.isEqual(this._numberOfApiCallRetries, NumberOfRetries.NoRetries)) {
            apiRequestMethodToPatch = this._getRetryWrappedMethod(apiRequestMethodToPatch);
        }
        this.apiRequest = apiRequestMethodToPatch;
    }
    _setMethodsPatchOptions(options = {}) {
        this._useLimiter = _.isNil(options.useLimiter) ? true : options.useLimiter;
        this._numberOfApiCallRetries = _.isNil(options.numberOfApiCallRetries)
            ? NumberOfRetries.NoRetries
            : options.numberOfApiCallRetries;
        if (this._useLimiter) {
            this._limiterOptions = _.isNil(options.limiterOptions) ? DEFAULT_LIMITER_OPTIONS : options.limiterOptions;
            this._limiter = new bottleneck_1.default(this._limiterOptions);
            const limiterMinTime = _.get(this._limiterOptions, 'minTime') || 0;
            if (limiterMinTime < SEARCH_LIMITER_MIN_TIME) {
                this._useSearchLimiter = true;
                const minTime = SEARCH_LIMITER_MIN_TIME - limiterMinTime;
                const id = `search-${this._limiterOptions.id}`;
                this._searchLimiterOptions = Object.assign(Object.assign({}, this._limiterOptions), { minTime, id, maxConcurrent: 3 });
                this._searchLimiter = new bottleneck_1.default(this._searchLimiterOptions);
            }
        }
        if (this._useLimiter || !_.isEqual(this._numberOfApiCallRetries, NumberOfRetries.NoRetries)) {
            this._patchApiClients();
            this._patchApiRequestMethod();
        }
    }
    _setInterceptors(options = {}) {
        if (options.interceptors) {
            _.each(options.interceptors, this.addInterceptor.bind(this));
        }
    }
}
exports.Client = Client;
